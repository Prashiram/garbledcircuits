#include<stdio.h>
#include<stdlib.h>
#include<sys/types.h>
#include<sys/socket.h>
#include <arpa/inet.h>
#include <strings.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h> /* for pid_t */
#include <sys/wait.h> /* for wait */
#include<netinet/in.h>
#define BUFFER_SIZE 350

int main(int argc, char** argv)
{
	int bob,alice,len;
	FILE *random,*c_bob, *enc_messages;

	//Creation of socket Alice
	alice = socket(AF_INET, SOCK_STREAM, 0);

	//Setting necessary values for the server
	struct sockaddr_in server_alice;
	struct sockaddr_in server_bob;
	server_alice.sin_family=AF_INET;
	server_alice.sin_port=htons(atoi(argv[1]));
	server_alice.sin_addr.s_addr=INADDR_ANY;
	bzero(&server_alice.sin_zero, 8);

	//Binding socket Alice to the server values set for alice_server
	if((bind(alice, (struct sockaddr*)&server_alice, sizeof(struct sockaddr_in))) == -1){
		printf("Server binding unsuccessful!\n");
		exit(-1);
	}

	//Server listens to just one connection at a time
	if((listen(alice, 1)) == -1){
		printf("Listen unsuccessful!\n");
		exit(-1);
	}
	else
		printf("Alice is listening....\n");

	//len contains size of structure sockaddr_in
	len=sizeof(struct sockaddr_in);

	//Accepts incoming connection request
	if((bob=accept(alice, (struct sockaddr *)&server_bob, &len)) < 0){
		printf("Unable to accept connection!\n");
		exit(-1);
	}
	else
		printf("Alice has accepted a connection...\n");

	
	//Buffer of length BUFFER_SIZE is used to send and recieve messages
	char *buffer;
	buffer=(char*)malloc(BUFFER_SIZE*sizeof(char));
	
	
	//Fork to execute alice1
	pid_t pid=fork();

	//child process
	if(pid==0)
	{
		//Execute alice1
		static char *argv[]={"alice1",NULL};
		execv("alice1", argv);
		exit(-1);
	}

	//Waits for execution of alice1 to finish
	wait(NULL);

	
	//text file that stores random numbers generates in alice1
	random=fopen("randomx.txt","r");
	
	//Send randomly generated nymbers by alice1 to bob
	fscanf(random,"%s",buffer);
	send(bob, buffer, BUFFER_SIZE, 0);
	bzero(buffer, strlen(buffer));
	fscanf(random,"%s",buffer);
	send(bob, buffer, BUFFER_SIZE, 0);
	bzero(buffer, BUFFER_SIZE);

	fclose(random);
	printf("Alice has sent randomly generated numbers\n");
	
	
	//text file that stores the c generated by Bob
	c_bob = fopen("bob_c.txt", "w");

	//Recieve the c generated by Bob and store in text file
	recv(bob, buffer, BUFFER_SIZE, 0);
	fprintf(c_bob,"%s",buffer);
	bzero(buffer, strlen(buffer));

	fclose(c_bob);
	printf("Alice has recieved c from Bob\n");


	//Fork to execute alice2
	pid=fork();

	//child process
	if(pid==0)
	{
		//child process alice2
		static char *argv[]={"alice2",NULL};
		execv("alice2", argv);
		exit(-1);
	}

	//Waits for alice2 to finish
	wait(NULL);

	
	//text file that stores the encrypted messages generated by alice1
	enc_messages = fopen("enc_messages.txt", "r");

	//Send encrypted messages generated by alice2 to Bob
	fscanf(enc_messages,"%s",buffer);
	send(bob, buffer, BUFFER_SIZE, 0);
	bzero(buffer, BUFFER_SIZE);
	fscanf(enc_messages,"%s",buffer);
	send(bob, buffer, BUFFER_SIZE, 0);
	bzero(buffer, BUFFER_SIZE);

	fclose(enc_messages);
	printf("Encrypted messages sent to Bob\n");

	
	//Close connection with Bob
	close(bob);
	printf("Transfer Completed\n");
}